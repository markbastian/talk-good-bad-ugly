<!DOCTYPE html>
<html><head><meta charset="utf-8"><title>Clojure: State</title><meta content="Functional Programming: Writing Stateless Code in a Stateful World with Clojure" name="description"><meta content="Mark Bastian" name="author"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui" name="viewport"><link href="bower_components/reveal.js/css/reveal.css" rel="stylesheet" type="text/css"><link href="bower_components/reveal.js/css/theme/black.css" rel="stylesheet" type="text/css"><link href="bower_components/reveal.js/lib/css/zenburn.css" rel="stylesheet" type="text/css"><!-- Printing and PDF exports --><script>
			var link = document.createElement( 'link' );
			link.rel = 'stylesheet';
			link.type = 'text/css';
			link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
			document.getElementsByTagName( 'head' )[0].appendChild( link );
		</script><!--[if lt IE 9]>
		<script src="bower_components/html5shiv/dist/html5shiv.js"></script>
		<![endif]--></head><body><div class="reveal"><!-- Any section element inside of this container is displayed as a slide --><div class="slides"><section><h2>Functional Programming</h2><h4>Writing Stateless Code in a Stateful World with Clojure</h4><p>Mark Bastian</p><small><p><a href="mailto:markbastian@gmail.com?Subject=Syntax">markbastian@gmail.com</a></p><p><a href="https://twitter.com/mark_bastian">@mark_bastian</a></p></small><p>3/24/2015</p></section><section><h2>Overview</h2><ul><li>Why?</li><li>Functional Programming</li><li>State</li><li>How - With Examples</li><li>Conclusion</li></ul></section><section><h2>Teaser</h2><ul style="float:left;width:50%;"><li>Flocking Behaviors</li><li>Based on Craig Reynold's Flocking Algorithms</li><li>Stateless*</li><li>Stick around to see how it's done</li></ul><canvas id="flocking-canvas" style="float:right;width:50%;"></canvas><script src="js/flocking.js" type="text/javascript"></script><script type="text/javascript">flocking.game_launcher.launch_app(document.getElementById("flocking-canvas"), 400, 400, 20);</script></section><section><h2>Why am I (are you) here?</h2><ul><li>JVM developer for over a decade<ul><li>C++, VB before that</li><li>Lots of OOP</li></ul></li><li>Scala (~2009)<ul><li>Clojure was weird</li><li>I got FP</li><li>I had questions</li></ul></li><li>Clojure<ul><li>I got answers</li><li>I want you to fast track</li></ul></li></ul></section><section><h2>Questions</h2><ul><li>What is FP?</li><li>What is state?</li><li>How do I eliminate state?</li><li>How do I manage state?</li></ul></section><section><section><h2>Functional Programming</h2></section><section><h2>What is Functional Programming?</h2><blockquote cite="http://en.wikipedia.org/wiki/Functional_programming">&ldquo;In computer science, functional programming is a programming paradigm, a style of building the structure and
  elements of computer programs, that treat computation as the evaluation of mathematical functions and avoids
  changing-state and mutable data.&rdquo;</blockquote><span style="position:absolute;bottom:-10;right:150;font-size:0.5em">http://en.wikipedia.org/wiki/Functional_programming</span></section><section><h2>Properties of Functions</h2><img src="images/191px-Function_machine2.png"><ul style="float:right;width:50%;"><li>Map inputs to outputs</li><li>Values vs. variables</li><li>No side-effects</li></ul></section><section><h2>Why FP?</h2><ul><li>Implicit concurrency</li><li>Code is easier to reason about</li><li>Greater reuse</li><li>Easier abstractions lead to less code</li></ul></section><section><h2>However...</h2><ul><li>FP tends to be very confusing coming from an OOP background</li><li>How can you do anything useful when there is no state or side-effects?<ul><li>The world has state....</li><li>FP has no state...</li></ul></li><li>That is what this talk is about</li></ul></section></section><section><section><h1>State</h1></section><section><h2>What is State?</h2><blockquote cite="https://en.wikipedia.org/wiki/State">&ldquo;State, a complete description of a system in classical mechanics&rdquo;</blockquote><span style="position:relative;bottom:0;right:-210;font-size:0.5em">https://en.wikipedia.org/wiki/State</span><blockquote cite="https://www.google.com/search?q=what+is+state&amp;oq=what+is+state">&ldquo;the particular condition that someone or something is in at a specific time.&rdquo;</blockquote><span style="position:relative;bottom:0;right:-80;font-size:0.5em">https://www.google.com/search?q=what+is+state&oq=what+is+state</span></section><section><h2>What is Program State?</h2><ul><li>A representation of the system</li><li>Often confusing because of differing definitions across communities</li><li>There are two views on state:<ul><li>Mutable: A changeable variable used to represent the &ldquo;current&rdquo; state of computation<ul><li>This is OOP state</li></ul></li><li>Immutable: A single, non-changing, constant value<ul><li>This is FP state (what we want)</li></ul></li></ul></li></ul></section><section><h2>But...</h2><ul><li>If nothing changes, how does anything happen?</li><li>An analogy...</li></ul></section><section><h2>The Traditional Universe</h2><ul><li>Time flows forward like a river</li><li>Things/events happen</li><li>State is the management of all possible events and conditions in the universe</li><li>This is the object-oriented view of reality</li></ul></section><section><h2>The Multiverse</h2><ul><li>A universe is a single, discrete, immutable value frozen in time</li><li>There are infinitely many of these universes</li><li>Events are &ldquo;Quantum Leaps&rdquo; into a different universe</li><li>State is simply a reference to one or more universes of interest</li><li>This is the functional view of reality</li></ul></section><section><h2>What if things were Multiversic?</h2><ul><li>Universes are stable</li><li>It is trivial to inspect a universe</li><li>Universes can share commonalities</li><li>A device is needed to transit universes</li><li>You must keep track of extant universes</li></ul></section><section><h2>Multiversic = FP</h2><ul><li>Values are stable</li><li>Values are trivial to inspect and understand</li><li>Values can share data</li><li>Functions are the means of transitioning between values</li><li>Keeping track of values is a separate concern</li></ul></section><section><h2>Concerns of State in Either Model</h2><ul><li>Representation: How do I represent state?</li><li>Transition: How do I get from one state representation to another?</li><li>Management: How do I keep track of states(s) of interest?</li></ul></section><section><h2>Comparison of Paradigms</h2><table><thead><tr><th>Aspect</th><th>OOP</th><th>FP</th></tr></thead><tbody><tr><td>State</td><td>Object Fields</td><td>Values</td></tr><tr><td>Transition</td><td>Object Methods</td><td>Functions</td></tr><tr><td>Management</td><td>Object References</td><td>Concurrency Primitives</td></tr><tr class="fragment"><td>Concerns</td><td>Complected</td><td>Separated</td></tr></tbody></table></section><section><h2>Since this talks is on FP...</h2><ul><li>Immutability is obviously better</li><li>We'll now talk about how to do it</li></ul></section></section><section><section><h1>How</h1></section><section><h2>FP in Practice</h2><ul><li>A practical roadmap of how to get there</li><li>What languages support each stage</li></ul></section><section><h2>Stages of FP</h2><ul><li>Lambdas/Closures/First Class Functions</li><li>Persistent collections</li><li>Immutable classes</li><li>Concurrent state management</li></ul></section><section><h2>Lambdas/Closures</h2><ul><li>Lambdas are simply anonymous functions</li><li>Closures are lambdas that </li></ul></section><section><h2>Persistent Collections</h2><ul><li>Immutable</li><li>Shared data for efficiency and speed</li><li>Functional operations</li></ul></section><section><h2>Value Classes</h2><ul><li>Final</li><li>Implement equals and hashcode</li><li>Often have convenience methods for 1-off copies</li><li>Language support<ul><li>Java: No</li><li>Scala: Case classes</li><li>Clojure: defrecords, but everyone uses persistent collections instead</li></ul></li></ul></section><section><h2>Managing State Concurrently</h2><ul><li>Java: No</li><li>Scala: No, but you can use Akka</li><li>Clojure: Yes - and you can use it in Java or Scala</li></ul></section><section><h2>Clojure Concurrency Primitives</h2><ul><li>Atoms<ul><li>Synchronous, Uncoordinated</li><li>The workhorse of Clojure concurrency</li></ul></li><li>Agents<ul><li>Asynchronous, Uncoordinated</li><li>Reactive</li></ul></li><li>Refs<ul><li>Synchronous, Coordinated</li><li>Banking and other transactional operations</li></ul></li></ul></section></section><section><section><h2>State Management</h2><ul><li>Ultimately, you will likely need persistent references to changing values</li><li>Clojure provides facilities for managing these references</li><li>Reference types<ul><li>Atoms: Uncoordinated, synchronous</li><li>Refs: Coordinated, synchronous</li><li>Agents: Independent, asynchronous</li></ul></li></ul></section><section><h2>Vars</h2><p>Thread-Local Binding</p><pre style="float:left;width:48%;height:100%;font-size:40%;"><code class="clj" contenteditable="contenteditable" data-trim="data-trim">(def ^:dynamic *a* 0)
(def ^:dynamic *b* 1)

(prn (str &quot;original a, b = &quot; *a* &quot;,&quot; *b*))

(binding [*a* 1 *b* 0]
  (prn (str &quot;rebound a, b = &quot; *a* &quot;,&quot; *b*))
  (binding [*a* 11 *b* 45]
    (prn (str &quot;rebound a, b = &quot; *a* &quot;,&quot; *b*)))
  (prn (str &quot;popped a, b = &quot; *a* &quot;,&quot; *b*)))

(prn (str &quot;popped a, b = &quot; *a* &quot;,&quot; *b*))</code></pre><pre style="float:right;width:48%;height:100%;"><code class="clj" contenteditable="contenteditable" data-trim="data-trim">&quot;original a, b = 0,1&quot;
&quot;rebound a, b = 1,0&quot;
&quot;rebound a, b = 11,45&quot;
&quot;popped a, b = 1,0&quot;
&quot;popped a, b = 0,1&quot;</code></pre></section><section><h2>Atoms</h2><p>Uncoordinated, Synchronous</p><pre style="float:left;width:48%;height:100%;font-size:40%;"><code class="clj" contenteditable="contenteditable" data-trim="data-trim">(def a (atom 0))
(def b (atom 1))

(defn slow [f] (Thread/sleep 300) f)
(defn slower [f] (Thread/sleep 400) f)

(future
  (do
    (swap! a (comp slow inc))
    (swap! b (comp slower dec))))

(future
  (loop [i 10]
    (when (pos? i)
      (do
        (prn (str &quot;a, b = &quot; @a &quot;,&quot; @b))
        (Thread/sleep 100)
        (recur (dec i))))))</code></pre><pre style="float:right;width:48%;height:100%;"><code class="clj" contenteditable="contenteditable" data-trim="data-trim">&quot;a, b = 0,1&quot;
&quot;a, b = 0,1&quot;
&quot;a, b = 0,1&quot;
&quot;a, b = 1,1&quot; ;slow completes
&quot;a, b = 1,1&quot;
&quot;a, b = 1,1&quot;
&quot;a, b = 1,1&quot;
&quot;a, b = 1,0&quot; ;slower completes
&quot;a, b = 1,0&quot;
&quot;a, b = 1,0&quot;</code></pre></section><section><h2>Agents</h2><p>Uncoordinated, Asynchronous</p><pre style="float:left;width:48%;height:100%;font-size:40%;"><code class="clj" contenteditable="contenteditable" data-trim="data-trim">(def a (agent 0))
(def b (agent 1))

(defn slow [f] (Thread/sleep 300) f)
(defn slower [f] (Thread/sleep 400) f)

(future
  (do
    (send a (comp slow inc))
    (send b (comp slower dec))))

(future
  (loop [i 10]
    (when (pos? i)
      (do
        (prn (str &quot;a, b = &quot; @a &quot;,&quot; @b))
        (Thread/sleep 100)
        (recur (dec i))))))</code></pre><pre style="float:right;width:48%;height:100%;"><code class="clj" contenteditable="contenteditable" data-trim="data-trim">&quot;a, b = 0,1&quot; ;Both sends immediately return
&quot;a, b = 0,1&quot;
&quot;a, b = 0,1&quot;
&quot;a, b = 1,1&quot; ;slow completes
&quot;a, b = 1,0&quot; ;slower completes
&quot;a, b = 1,0&quot;
&quot;a, b = 1,0&quot;
&quot;a, b = 1,0&quot;
&quot;a, b = 1,0&quot;
&quot;a, b = 1,0&quot;</code></pre></section><section><h2>Refs</h2><p>Coordinated, Synchronous</p><pre style="float:left;width:48%;height:100%;font-size:40%;"><code class="clj" contenteditable="contenteditable" data-trim="data-trim">(def a (ref 0))
(def b (ref 1))

(defn slow [f] (Thread/sleep 300) f)
(defn slower [f] (Thread/sleep 400) f)

(future
  (dosync
    (alter a (comp slow inc))
    (alter b (comp slower dec))))

(future
  (loop [i 10]
    (when (pos? i)
      (do
        (prn (str &quot;a, b = &quot; @a &quot;,&quot; @b))
        (Thread/sleep 100)
        (recur (dec i))))))</code></pre><pre style="float:right;width:48%;height:100%;"><code class="clj" contenteditable="contenteditable" data-trim="data-trim">&quot;a, b = 0,1&quot;
&quot;a, b = 0,1&quot;
&quot;a, b = 0,1&quot;
&quot;a, b = 0,1&quot; ;slow completes?
&quot;a, b = 0,1&quot;
&quot;a, b = 0,1&quot;
&quot;a, b = 0,1&quot;
&quot;a, b = 1,0&quot; ;both actions complete
&quot;a, b = 1,0&quot;
&quot;a, b = 1,0&quot;</code></pre></section><section><h2>Channels</h2><p>Coordinated, Synchronous</p><pre style="float:left;width:48%;height:100%;font-size:40%;"><code class="clj" contenteditable="contenteditable" data-trim="data-trim">(def a (ref 0))
(def b (ref 1))

(defn slow [f] (Thread/sleep 300) f)
(defn slower [f] (Thread/sleep 400) f)

(future
  (dosync
    (alter a (comp slow inc))
    (alter b (comp slower dec))))

(future
  (loop [i 10]
    (when (pos? i)
      (do
        (prn (str &quot;a, b = &quot; @a &quot;,&quot; @b))
        (Thread/sleep 100)
        (recur (dec i))))))</code></pre><pre style="float:right;width:48%;height:100%;"><code class="clj" contenteditable="contenteditable" data-trim="data-trim">&quot;a, b = 0,1&quot;
&quot;a, b = 0,1&quot;
&quot;a, b = 0,1&quot;
&quot;a, b = 0,1&quot; ;slow completes?
&quot;a, b = 0,1&quot;
&quot;a, b = 0,1&quot;
&quot;a, b = 0,1&quot;
&quot;a, b = 1,0&quot; ;both actions complete
&quot;a, b = 1,0&quot;
&quot;a, b = 1,0&quot;</code></pre></section></section><section><h2>Other Languages?</h2><ul><li>Scala<ul><li>Akka</li><li>Not baked in</li><li>Actors</li><li>STM</li></ul></li><li>Clojure<ul><li>Batteries included</li></ul></li></ul></section><section><h2>Stateless Predator Prey</h2><div style="float:left;width:400px;"><div><small><label style="display: inline-block; width: 250px;">Initial Prey Population</label></small><input id="prey-population-slider" max="500" min="0" step="1" type="range"></div><div><small><label style="display: inline-block; width: 250px;">Initial Predator Population</label></small><input id="predator-population-slider" max="500" min="0" step="1" type="range"></div><div><small><label style="display: inline-block; width: 250px;">Reproduction Rate</label></small><input id="reproduction-rate-slider" max="500" min="0" step="1" type="range"></div><div><small><label style="display: inline-block; width: 250px;">Predation Rate</label></small><input id="predation-rate-slider" max="500" min="0" step="1" type="range"></div><div><small><label style="display: inline-block; width: 250px;">Growth Rate</label></small><input id="growth-rate-slider" max="500" min="0" step="1" type="range"></div><div><small><label style="display: inline-block; width: 250px;">Death Rate</label></small><input id="death-rate-slider" max="500" min="0" step="1" type="range"></div></div><canvas height="400" id="rk-canvas" style="border:1px solid #000000;" width="400"></canvas><script src="js/rk.js" type="text/javascript"></script><script type="text/javascript">numerics.canvasui.init(document.getElementById("rk-canvas"));</script></section><section><h2>Data Modeling Tips</h2><ul><li>Entity Maps</li><li>Cycles via identifiers</li><li>Use UUIDs or other unique identifiers</li><li>Names make poor identifiers</li></ul></section><section><h2>Overview</h2><ul><li>Why?</li><li>Functional Programming</li><li>State</li><li>How - With Examples</li><li>Conclusion</li></ul></section><section><h2>In Conclusion:</h2><h2>Yes, you can be stateless</h2><ul><li>It's a different way of thinking</li><li>Threading and api design</li><li>Come see my other talk</li></ul></section></div></div><script src="bower_components/reveal.js/lib/js/head.min.js" type="text/javascript"></script><script src="bower_components/reveal.js/js/reveal.js" type="text/javascript"></script><script src="bower_components/MathJax/MathJax.js?config=TeX-AMS_HTML-full" type="text/javascript"></script><script src="js/reveal-cl.js" type="text/javascript"></script><script src="MathJax.Hub.Config({
        tex2jax: {inlineMath: [[&amp;quot;$&amp;quot;,&amp;quot;$&amp;quot;],[&amp;quot;\(&amp;quot;,&amp;quot;\)&amp;quot;]]}
      });" type="text/x-mathjax-config"></script></body></html>